<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Model Forecast - Smart Blend</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #2a2a2a;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #fff;
        }

        .subtitle {
            font-size: 14px;
            color: #999;
            margin-bottom: 20px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        input {
            padding: 12px 16px;
            background: #252525;
            border: 2px solid #333;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .get-forecast-btn {
            padding: 12px 32px;
            background: #4a90e2;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .get-forecast-btn:hover {
            background: #3d7bc7;
        }

        .preset-locations {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .preset-btn {
            padding: 8px 16px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            color: #999;
            cursor: pointer;
            font-size: 13px;
        }

        .preset-btn:hover {
            border-color: #555;
            color: #e0e0e0;
        }

        .forecast-section {
            display: none;
        }

        .forecast-section.active {
            display: block;
        }

        .current-weather {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #2a2a2a;
        }

        .location-header {
            margin-bottom: 20px;
        }

        .location-name {
            font-size: 24px;
            color: #fff;
            margin-bottom: 5px;
        }

        .model-name {
            color: #4a90e2;
            font-size: 14px;
        }

        .current-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .current-item {
            background: #252525;
            padding: 20px;
            border-radius: 8px;
        }

        .current-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
        }

        .current-value {
            font-size: 32px;
            font-weight: 700;
            color: #fff;
        }

        .current-value.temp {
            color: #4a90e2;
        }

        .current-value.wind {
            color: #f39c12;
        }

        .current-value.precip {
            color: #5ebd5e;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .chart-card {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }

        .chart-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: #fff;
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #3d2020;
            color: #ff6b6b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .hourly-forecast {
            margin-bottom: 20px;
        }

        .daily-forecast {
            margin-bottom: 20px;
        }

        .radar-section {
            margin-bottom: 20px;
        }

        .historical-section {
            margin-bottom: 20px;
        }

        #radarMap {
            z-index: 1;
        }

        .daily-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .daily-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 15px;
        }

        .daily-title {
            font-size: 16px;
            font-weight: 600;
            color: #4a90e2;
            margin-bottom: 12px;
            border-bottom: 2px solid #2a2a2a;
            padding-bottom: 8px;
        }

        .daily-content {
            font-size: 13px;
            line-height: 1.6;
        }

        .daily-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .daily-label {
            color: #999;
        }

        .daily-value {
            font-weight: 600;
            color: #e0e0e0;
        }

        .daily-value.temp {
            color: #4a90e2;
        }

        .daily-value.wind {
            color: #f39c12;
        }

        .daily-value.rain {
            color: #3498db;
        }

        .daily-value.snow {
            color: #9b59b6;
        }

        .hourly-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .hourly-table th {
            background: #252525;
            padding: 12px 8px;
            text-align: left;
            color: #999;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .hourly-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #2a2a2a;
        }

        .hourly-table tr:hover {
            background: #1f1f1f;
        }

        .temp-cell {
            color: #4a90e2;
            font-weight: 600;
        }

        .precip-cell {
            color: #5ebd5e;
        }

        .wind-cell {
            color: #f39c12;
        }

        .rain-cell {
            color: #3498db;
        }

        .snow-cell {
            color: #9b59b6;
        }

        .model-info {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .model-info strong {
            color: #4a90e2;
        }

        @media (max-width: 768px) {
            .input-group {
                grid-template-columns: 1fr;
            }
            
            .current-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1e40af">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Smart Blend Weather Forecast</h1>
            <div class="subtitle">Intelligently blends Weather.gov, Open-Meteo, ECMWF, and GFS based on forecast time range</div>
            
            <div class="input-group">
                <input type="text" id="cityInput" placeholder="Enter city name (e.g., Orlando, FL)" style="grid-column: 1 / -1;" onkeypress="if(event.key==='Enter') searchCity()">
                <button class="get-forecast-btn" onclick="searchCity()">Search City</button>
                <button class="get-forecast-btn" onclick="getCurrentLocation()" style="background: #5ebd5e;">Use Current Location</button>
            </div>

            <div class="preset-locations">
                <button class="preset-btn" onclick="setLocation(28.2189, -82.4526)">Land O' Lakes, FL</button>
                <button class="preset-btn" onclick="setLocation(41.2565, -74.3587)">Warwick, NY</button>
                <button class="preset-btn" onclick="setLocation(45.5017, -73.5673)">Montreal, QC</button>
                <button class="preset-btn" onclick="setLocation(46.8139, -71.2080)">Quebec City, QC</button>
                <button class="preset-btn" onclick="setLocation(28.5383, -81.3792)">Orlando, FL</button>
            </div>
        </div>

        <div class="error" id="error"></div>

        <div class="loading" id="loading" style="display: none;">
            Loading forecast data from multiple models...
        </div>

        <div class="forecast-section" id="forecast">
            <div class="current-weather">
                <div class="location-header">
                    <div class="location-name" id="locationName">--</div>
                    <div class="model-name" id="modelName">Smart Blend Forecast</div>
                    <div class="model-name" id="modelRun" style="color: #999; font-size: 12px; margin-top: 5px;">--</div>
                </div>

                <div class="current-grid">
                    <div class="current-item">
                        <div class="current-label">Temperature</div>
                        <div class="current-value temp" id="temp">--°F</div>
                    </div>
                    <div class="current-item">
                        <div class="current-label">Feels Like</div>
                        <div class="current-value temp" id="feelsLike">--°F</div>
                    </div>
                    <div class="current-item">
                        <div class="current-label">Wind Speed</div>
                        <div class="current-value wind" id="wind">-- mph</div>
                    </div>
                    <div class="current-item">
                        <div class="current-label">Wind Gusts</div>
                        <div class="current-value wind" id="windGusts">-- mph</div>
                    </div>
                    <div class="current-item">
                        <div class="current-label">Humidity</div>
                        <div class="current-value" id="humidity">--%</div>
                    </div>
                    <div class="current-item">
                        <div class="current-label">Precipitation</div>
                        <div class="current-value precip" id="precip">-- in</div>
                    </div>
                    <div class="current-item">
                        <div class="current-label">Pressure</div>
                        <div class="current-value" id="pressure">-- mb</div>
                    </div>
                    <div class="current-item">
                        <div class="current-label">Conditions</div>
                        <div class="current-value" style="font-size: 18px;" id="conditions">--</div>
                    </div>
                </div>
            </div>

            <div class="daily-forecast">
                <div class="daily-cards">
                    <div class="daily-card">
                        <div class="daily-title">Today</div>
                        <div class="daily-content" id="todayForecast">--</div>
                    </div>
                    <div class="daily-card">
                        <div class="daily-title">Tomorrow</div>
                        <div class="daily-content" id="tomorrowForecast">--</div>
                    </div>
                    <div class="daily-card">
                        <div class="daily-title">Day After</div>
                        <div class="daily-content" id="dayAfterForecast">--</div>
                    </div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="chart-title" style="margin: 0;">Temperature & Feels Like Forecast</div>
                        <select id="timeRange" onchange="updateCharts()" style="padding: 8px 12px; background: #252525; border: 1px solid #333; border-radius: 6px; color: #e0e0e0; font-size: 14px;">
                            <option value="24">24 Hours (Weather.gov + Best Match)</option>
                            <option value="48" selected>48 Hours (+ ECMWF)</option>
                            <option value="72">72 Hours (+ GFS)</option>
                            <option value="120">120 Hours (ECMWF + GFS)</option>
                            <option value="240">240 Hours (GFS Only)</option>
                        </select>
                    </div>
                    <div id="modelInfo24" class="model-info" style="display: none;">
                        <strong>0-24 hours:</strong> Weather.gov Blend + Open-Meteo Best Match averaged
                    </div>
                    <div id="modelInfo48" class="model-info">
                        <strong>0-24 hours:</strong> Weather.gov + Best Match<br>
                        <strong>25-48 hours:</strong> Weather.gov + Best Match + ECMWF averaged
                    </div>
                    <div id="modelInfo72" class="model-info" style="display: none;">
                        <strong>0-24 hours:</strong> Weather.gov + Best Match<br>
                        <strong>25-48 hours:</strong> Weather.gov + Best Match + ECMWF<br>
                        <strong>49-72 hours:</strong> Weather.gov + Best Match + ECMWF + GFS averaged
                    </div>
                    <div id="modelInfo120" class="model-info" style="display: none;">
                        <strong>0-24 hours:</strong> Weather.gov + Best Match<br>
                        <strong>25-48 hours:</strong> Weather.gov + Best Match + ECMWF<br>
                        <strong>49-72 hours:</strong> Weather.gov + Best Match + ECMWF + GFS<br>
                        <strong>73-120 hours:</strong> ECMWF + GFS averaged
                    </div>
                    <div id="modelInfo240" class="model-info" style="display: none;">
                        <strong>0-24 hours:</strong> Weather.gov + Best Match<br>
                        <strong>25-48 hours:</strong> Weather.gov + Best Match + ECMWF<br>
                        <strong>49-72 hours:</strong> Weather.gov + Best Match + ECMWF + GFS<br>
                        <strong>73-120 hours:</strong> ECMWF + GFS<br>
                        <strong>121-240 hours:</strong> GFS only
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Precipitation Probability & Type</div>
                    <div class="chart-wrapper">
                        <canvas id="precipChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Precipitation Accumulation</div>
                    <div id="precipTotals" style="font-size: 14px; color: #999; margin-bottom: 15px;">--</div>
                    <div class="chart-wrapper">
                        <canvas id="precipAccumChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Wind Speed & Gusts Forecast</div>
                    <div class="chart-wrapper">
                        <canvas id="windChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="historical-section">
                <div class="chart-card">
                    <div class="chart-title">Historical Weather (Past 24 Hours)</div>
                    <div class="chart-wrapper">
                        <canvas id="historicalChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="hourly-forecast">
                <div class="chart-card">
                    <div class="chart-title">Hourly Forecast</div>
                    <div id="hourlyTable" style="overflow-x: auto;"></div>
                </div>
            </div>

            <div class="radar-section">
                <div class="chart-card">
                    <div class="chart-title">Precipitation Radar</div>
                    <div id="radarContainer" style="height: 500px; position: relative; background: #0a0a0a; border-radius: 8px; overflow: hidden;">
                        <div id="radarMap" style="height: 100%; width: 100%;"></div>
                        <div id="radarTimeline" style="position: absolute; bottom: 20px; left: 10px; right: 10px; background: rgba(26, 26, 26, 0.9); padding: 15px; border-radius: 8px; z-index: 1000;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <button onclick="playRadarAnimation()" id="playBtn" style="padding: 8px 16px; background: #4a90e2; border: none; border-radius: 6px; color: #fff; cursor: pointer;">Play</button>
                                <button onclick="pauseRadarAnimation()" id="pauseBtn" style="padding: 8px 16px; background: #666; border: none; border-radius: 6px; color: #fff; cursor: pointer;">Pause</button>
                                <span id="radarTimeDisplay" style="color: #e0e0e0; font-size: 14px;">--</span>
                            </div>
                            <input type="range" id="radarSlider" min="0" max="0" value="0" style="width: 100%;" oninput="updateRadarFrame(this.value)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tempChart = null;
        let precipChart = null;
        let precipAccumChart = null;
        let windChart = null;
        let historicalChart = null;
        let currentForecastData = null;
        let radarMap = null;
        let radarMarker = null;
        let radarLayer = null;
        let radarFrames = [];
        let radarAnimationTimer = null;
        let currentFrameIndex = 0;

        function setLocation(lat, lng) {
            getForecast(lat, lng);
        }

        async function searchCity() {
            const cityName = document.getElementById('cityInput').value.trim();
            
            if (!cityName) {
                showError('Please enter a city name');
                return;
            }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`);
                const data = await response.json();

                if (data.length === 0) {
                    showError('City not found. Try including state/country (e.g., "Orlando, FL" or "Paris, France")');
                    return;
                }

                const lat = parseFloat(data[0].lat);
                const lng = parseFloat(data[0].lon);

                getForecast(lat, lng);
            } catch (err) {
                showError(`Error searching for city: ${err.message}`);
            }
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    getForecast(lat, lng);
                },
                (error) => {
                    document.getElementById('loading').style.display = 'none';
                    showError('Unable to get your location. Please enable location services or enter a city name.');
                }
            );
        }

        async function getForecast(lat, lng) {
            if (isNaN(lat) || isNaN(lng)) {
                showError('Please enter valid latitude and longitude values');
                return;
            }

            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showError('Latitude must be between -90 and 90, longitude between -180 and 180');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('forecast').classList.remove('active');
            document.getElementById('error').classList.remove('active');

            await fetchSmartBlend(lat, lng);
        }

        async function fetchSmartBlend(lat, lng) {
            try {
                const isUS = (lat >= 24 && lat <= 50 && lng >= -125 && lng <= -66);
                
                let promises = [];

                // Fetch Weather.gov if US
                if (isUS) {
                    promises.push(
                        fetch(`https://api.weather.gov/points/${lat.toFixed(4)},${lng.toFixed(4)}`, {
                            headers: {'User-Agent': '(WeatherApp, contact@example.com)'}
                        })
                        .then(r => r.json())
                        .then(p => fetch(p.properties.forecastHourly, {headers: {'User-Agent': '(WeatherApp, contact@example.com)'}}))
                        .then(r => r.json())
                        .then(d => ({type: 'weathergov', data: d}))
                        .catch(() => null)
                    );
                }

                // Fetch Open-Meteo models: Best Match, GFS, ECMWF
                promises.push(
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,wind_gusts_10m,surface_pressure&hourly=temperature_2m,apparent_temperature,precipitation_probability,precipitation,rain,showers,snowfall,wind_speed_10m,wind_gusts_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto&forecast_days=7&models=best_match`)
                    .then(r => r.json()).then(d => ({type: 'bestmatch', data: d})),
                    
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,wind_gusts_10m,surface_pressure&hourly=temperature_2m,apparent_temperature,precipitation_probability,precipitation,rain,showers,snowfall,wind_speed_10m,wind_gusts_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto&forecast_days=10&models=gfs_seamless`)
                    .then(r => r.json()).then(d => ({type: 'gfs', data: d})),
                    
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,apparent_temperature,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,wind_gusts_10m,surface_pressure&hourly=temperature_2m,apparent_temperature,precipitation_probability,precipitation,rain,showers,snowfall,wind_speed_10m,wind_gusts_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto&forecast_days=10&models=ecmwf_ifs025`)
                    .then(r => r.json()).then(d => ({type: 'ecmwf', data: d}))
                );

                const results = await Promise.all(promises);
                const validResults = results.filter(r => r !== null);

                if (validResults.length === 0) {
                    throw new Error('Failed to fetch any models');
                }

                // Find each model
                const weathergov = validResults.find(r => r.type === 'weathergov');
                const bestmatch = validResults.find(r => r.type === 'bestmatch');
                const gfs = validResults.find(r => r.type === 'gfs');
                const ecmwf = validResults.find(r => r.type === 'ecmwf');

                // Convert Weather.gov to standard format
                let weathergovData = null;
                if (weathergov) {
                    weathergovData = convertWeatherGovToStandard(weathergov.data.properties.periods);
                }

                // Build custom smart blend
                const blended = buildSmartBlend(weathergovData, bestmatch?.data.hourly, gfs?.data.hourly, ecmwf?.data.hourly);

                setLocationName(lat, lng);
                document.getElementById('modelRun').textContent = `Updated: ${new Date().toLocaleString('en-US', {month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', timeZoneName: 'short'})}`;

                // Average current conditions from Open-Meteo models
                const omModels = [bestmatch, gfs, ecmwf].filter(m => m).map(r => r.data.current);
                const avgTemp = omModels.reduce((s, d) => s + d.temperature_2m, 0) / omModels.length;
                const avgFeels = omModels.reduce((s, d) => s + (d.apparent_temperature || 0), 0) / omModels.length;
                const avgWind = omModels.reduce((s, d) => s + d.wind_speed_10m, 0) / omModels.length;
                const avgGusts = omModels.reduce((s, d) => s + (d.wind_gusts_10m || 0), 0) / omModels.length;
                const avgHumidity = omModels.reduce((s, d) => s + d.relative_humidity_2m, 0) / omModels.length;
                const avgPrecip = omModels.reduce((s, d) => s + (d.precipitation || 0), 0) / omModels.length;
                const avgPressure = omModels.reduce((s, d) => s + (d.surface_pressure || 0), 0) / omModels.length;

                document.getElementById('temp').textContent = `${Math.round(avgTemp)}°F`;
                document.getElementById('feelsLike').textContent = `${Math.round(avgFeels)}°F`;
                document.getElementById('wind').textContent = `${Math.round(avgWind)} mph`;
                document.getElementById('windGusts').textContent = `${Math.round(avgGusts)} mph`;
                document.getElementById('humidity').textContent = `${Math.round(avgHumidity)}%`;
                document.getElementById('precip').textContent = `${avgPrecip.toFixed(2)} in`;
                document.getElementById('pressure').textContent = `${Math.round(avgPressure)} mb`;
                document.getElementById('conditions').textContent = getWeatherDescription(omModels[0].weather_code);

                currentForecastData = blended;

                await fetchHistoricalAndFinish(lat, lng);

            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                showError(`Error loading forecast: ${err.message}`);
                console.error(err);
            }
        }

        function buildSmartBlend(weathergov, bestmatch, gfs, ecmwf) {
            // Find the longest forecast available (GFS should be longest)
            const maxLength = Math.max(
                weathergov?.time.length || 0,
                bestmatch?.time.length || 0,
                gfs?.time.length || 0,
                ecmwf?.time.length || 0
            );

            const blended = {
                time: [],
                temperature_2m: [],
                apparent_temperature: [],
                precipitation_probability: [],
                precipitation: [],
                rain: [],
                snowfall: [],
                wind_speed_10m: [],
                wind_gusts_10m: []
            };

            // Use GFS or ECMWF times as the base (they have the most hours)
            const baseTimes = gfs?.time || ecmwf?.time;
            
            for (let i = 0; i < maxLength; i++) {
                if (i < baseTimes.length) {
                    blended.time.push(baseTimes[i]);
                }

                let modelsToAvg = [];

                // 0-24 hours: Weather.gov + Best Match
                if (i < 24) {
                    if (weathergov && i < weathergov.time.length) modelsToAvg.push(weathergov);
                    if (bestmatch && i < bestmatch.time.length) modelsToAvg.push(bestmatch);
                }
                // 25-48 hours: Weather.gov + Best Match + ECMWF
                else if (i < 48) {
                    if (weathergov && i < weathergov.time.length) modelsToAvg.push(weathergov);
                    if (bestmatch && i < bestmatch.time.length) modelsToAvg.push(bestmatch);
                    if (ecmwf && i < ecmwf.time.length) modelsToAvg.push(ecmwf);
                }
                // 49-72 hours: Weather.gov + Best Match + ECMWF + GFS
                else if (i < 72) {
                    if (weathergov && i < weathergov.time.length) modelsToAvg.push(weathergov);
                    if (bestmatch && i < bestmatch.time.length) modelsToAvg.push(bestmatch);
                    if (ecmwf && i < ecmwf.time.length) modelsToAvg.push(ecmwf);
                    if (gfs && i < gfs.time.length) modelsToAvg.push(gfs);
                }
                // 73-120 hours: ECMWF + GFS
                else if (i < 120) {
                    if (ecmwf && i < ecmwf.time.length) modelsToAvg.push(ecmwf);
                    if (gfs && i < gfs.time.length) modelsToAvg.push(gfs);
                }
                // 121-240 hours: GFS only
                else {
                    if (gfs && i < gfs.time.length) modelsToAvg.push(gfs);
                }

                if (modelsToAvg.length === 0) break;

                // Average the models for this hour
                blended.temperature_2m[i] = modelsToAvg.reduce((s, m) => s + (m.temperature_2m[i] || 0), 0) / modelsToAvg.length;
                blended.apparent_temperature[i] = modelsToAvg.reduce((s, m) => s + (m.apparent_temperature?.[i] || m.temperature_2m[i]), 0) / modelsToAvg.length;
                blended.precipitation_probability[i] = modelsToAvg.reduce((s, m) => s + (m.precipitation_probability?.[i] || 0), 0) / modelsToAvg.length;
                blended.precipitation[i] = modelsToAvg.reduce((s, m) => s + (m.precipitation?.[i] || 0), 0) / modelsToAvg.length;
                blended.rain[i] = modelsToAvg.reduce((s, m) => s + (m.rain?.[i] || 0), 0) / modelsToAvg.length;
                blended.snowfall[i] = modelsToAvg.reduce((s, m) => s + (m.snowfall?.[i] || 0), 0) / modelsToAvg.length;
                blended.wind_speed_10m[i] = modelsToAvg.reduce((s, m) => s + (m.wind_speed_10m[i] || 0), 0) / modelsToAvg.length;
                blended.wind_gusts_10m[i] = modelsToAvg.reduce((s, m) => s + (m.wind_gusts_10m?.[i] || 0), 0) / modelsToAvg.length;
            }

            return blended;
        }

        function convertWeatherGovToStandard(periods) {
            const hourlyData = {
                time: [],
                temperature_2m: [],
                apparent_temperature: [],
                precipitation_probability: [],
                precipitation: [],
                rain: [],
                snowfall: [],
                wind_speed_10m: [],
                wind_gusts_10m: []
            };

            periods.forEach(period => {
                hourlyData.time.push(period.startTime);
                hourlyData.temperature_2m.push(period.temperature);
                hourlyData.apparent_temperature.push(period.temperature);
                hourlyData.precipitation_probability.push(period.probabilityOfPrecipitation?.value || 0);
                hourlyData.precipitation.push(0);
                hourlyData.rain.push(0);
                hourlyData.snowfall.push(0);
                
                const windMatch = period.windSpeed.match(/(\d+)/);
                const windSpeed = windMatch ? parseInt(windMatch[1]) : 0;
                hourlyData.wind_speed_10m.push(windSpeed);
                hourlyData.wind_gusts_10m.push(windSpeed * 1.3); // Estimate gusts as 1.3x wind speed
            });

            return hourlyData;
        }

        async function setLocationName(lat, lng) {
            try {
                const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                const geoData = await geoResponse.json();
                const locationName = geoData.address?.city || geoData.address?.town || geoData.address?.county || 'Unknown Location';
                document.getElementById('locationName').textContent = `${locationName} (${lat.toFixed(4)}°, ${lng.toFixed(4)}°)`;
            } catch (e) {
                document.getElementById('locationName').textContent = `${lat.toFixed(4)}°, ${lng.toFixed(4)}°`;
            }
        }

        async function fetchHistoricalAndFinish(lat, lng) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const today = new Date();
            const startDate = yesterday.toISOString().split('T')[0];
            const endDate = today.toISOString().split('T')[0];
            
            const historicalUrl = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lng}&start_date=${startDate}&end_date=${endDate}&hourly=temperature_2m,precipitation,rain,snowfall,wind_speed_10m,wind_gusts_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto`;
            const historicalResponse = await fetch(historicalUrl);
            const historicalData = historicalResponse.ok ? await historicalResponse.json() : null;

            updateCharts(historicalData);
            initRadar(lat, lng);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('forecast').classList.add('active');
        }

        async function initRadar(lat, lng) {
            if (!radarMap) {
                radarMap = L.map('radarMap').setView([lat, lng], 7);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap, &copy; CARTO',
                    maxZoom: 19
                }).addTo(radarMap);
            } else {
                radarMap.setView([lat, lng], 7);
            }

            if (radarMarker) radarMap.removeLayer(radarMarker);
            radarMarker = L.marker([lat, lng]).addTo(radarMap);
            radarMarker.bindPopup('Your Location').openPopup();

            await loadRainViewerRadar();
            setTimeout(() => radarMap.invalidateSize(), 100);
        }

        async function loadRainViewerRadar() {
            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await response.json();
                
                radarFrames = [];
                if (data.radar?.past) {
                    radarFrames = data.radar.past.map(frame => ({time: frame.time, path: frame.path, isPast: true}));
                }
                if (data.radar?.nowcast) {
                    radarFrames = radarFrames.concat(data.radar.nowcast.map(frame => ({time: frame.time, path: frame.path, isPast: false})));
                }
                
                if (radarFrames.length > 0) {
                    const slider = document.getElementById('radarSlider');
                    slider.max = radarFrames.length - 1;
                    slider.value = radarFrames.length - 1;
                    currentFrameIndex = radarFrames.length - 1;
                    updateRadarFrame(currentFrameIndex);
                }
            } catch (err) {
                console.error('Error loading radar:', err);
            }
        }

        function updateRadarFrame(frameIndex) {
            currentFrameIndex = parseInt(frameIndex);
            if (radarFrames.length === 0 || !radarMap) return;
            
            const frame = radarFrames[currentFrameIndex];
            if (radarLayer) radarMap.removeLayer(radarLayer);
            
            radarLayer = L.tileLayer(`https://tilecache.rainviewer.com${frame.path}/256/{z}/{x}/{y}/2/1_1.png`, {
                attribution: 'RainViewer', opacity: 0.7, maxZoom: 12
            }).addTo(radarMap);
            
            const date = new Date(frame.time * 1000);
            const timeStr = date.toLocaleString('en-US', {month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'});
            document.getElementById('radarTimeDisplay').textContent = `${timeStr} (${frame.isPast ? 'Past' : 'Forecast'})`;
        }

        function playRadarAnimation() {
            if (radarAnimationTimer) return;
            radarAnimationTimer = setInterval(() => {
                currentFrameIndex = (currentFrameIndex + 1) % radarFrames.length;
                document.getElementById('radarSlider').value = currentFrameIndex;
                updateRadarFrame(currentFrameIndex);
            }, 500);
        }

        function pauseRadarAnimation() {
            if (radarAnimationTimer) {
                clearInterval(radarAnimationTimer);
                radarAnimationTimer = null;
            }
        }

        function updateCharts(historicalData) {
            if (!currentForecastData) return;

            const timeRange = parseInt(document.getElementById('timeRange').value);
            
            // Show/hide model info boxes
            document.getElementById('modelInfo24').style.display = timeRange === 24 ? 'block' : 'none';
            document.getElementById('modelInfo48').style.display = timeRange === 48 ? 'block' : 'none';
            document.getElementById('modelInfo72').style.display = timeRange === 72 ? 'block' : 'none';
            document.getElementById('modelInfo120').style.display = timeRange === 120 ? 'block' : 'none';
            document.getElementById('modelInfo240').style.display = timeRange === 240 ? 'block' : 'none';

            const hourlyData = currentForecastData;
            
            const now = new Date();
            let startIndex = hourlyData.time.findIndex(t => new Date(t) >= now);
            if (startIndex === -1) startIndex = 0;
            
            const hours = hourlyData.time.slice(startIndex, startIndex + timeRange).map(time => 
                new Date(time).toLocaleString('en-US', {month: 'short', day: 'numeric', hour: 'numeric'})
            );

            const temps = hourlyData.temperature_2m.slice(startIndex, startIndex + timeRange);
            const feelsLike = hourlyData.apparent_temperature?.slice(startIndex, startIndex + timeRange) || temps;
            const precipProb = hourlyData.precipitation_probability?.slice(startIndex, startIndex + timeRange) || Array(timeRange).fill(0);
            const totalPrecip = hourlyData.precipitation?.slice(startIndex, startIndex + timeRange) || Array(timeRange).fill(0);
            const rain = hourlyData.rain?.slice(startIndex, startIndex + timeRange) || totalPrecip;
            const snow = hourlyData.snowfall?.slice(startIndex, startIndex + timeRange) || Array(timeRange).fill(0);
            const wind = hourlyData.wind_speed_10m.slice(startIndex, startIndex + timeRange);
            const gusts = hourlyData.wind_gusts_10m?.slice(startIndex, startIndex + timeRange) || wind.map(w => w * 1.3);

            const totalRain = rain.reduce((a, b) => a + (b || 0), 0);
            const totalSnow = snow.reduce((a, b) => a + (b || 0), 0);
            const totalAll = totalPrecip.reduce((a, b) => a + (b || 0), 0);
            
            document.getElementById('precipTotals').innerHTML = `<strong>Total:</strong> ${totalAll.toFixed(2)}" (Rain: ${totalRain.toFixed(2)}", Snow: ${totalSnow.toFixed(2)}")`;

            generateDailyForecasts(hourlyData, startIndex);
            if (historicalData) generateHistoricalChart(historicalData);
            generateHourlyTable(hours, temps, feelsLike, precipProb, totalPrecip, rain, snow, wind, gusts);

            if (tempChart) tempChart.destroy();
            tempChart = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Temperature (°F)',
                        data: temps,
                        borderColor: '#4a90e2',
                        backgroundColor: 'rgba(74, 144, 226, 0.1)',
                        tension: 0.4,
                        borderWidth: 2
                    }, {
                        label: 'Feels Like (°F)',
                        data: feelsLike,
                        borderColor: '#e74c3c',
                        tension: 0.4,
                        borderWidth: 2,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {labels: {color: '#e0e0e0'}}},
                    scales: {
                        x: {ticks: {color: '#999', maxRotation: 45, minRotation: 45}, grid: {color: '#2a2a2a'}},
                        y: {ticks: {color: '#4a90e2'}, grid: {color: '#2a2a2a'}}
                    }
                }
            });

            if (precipChart) precipChart.destroy();
            precipChart = new Chart(document.getElementById('precipChart'), {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Precip Probability (%)',
                        data: precipProb,
                        backgroundColor: 'rgba(94, 189, 94, 0.6)',
                        borderColor: '#5ebd5e',
                        type: 'line',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Rain (in)',
                        data: rain,
                        backgroundColor: '#3498db',
                        yAxisID: 'y1'
                    }, {
                        label: 'Snow (in)',
                        data: snow,
                        backgroundColor: '#ecf0f1',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {labels: {color: '#e0e0e0'}}},
                    scales: {
                        x: {stacked: true, ticks: {color: '#999', maxRotation: 45}, grid: {color: '#2a2a2a'}},
                        y: {position: 'left', ticks: {color: '#5ebd5e'}, grid: {color: '#2a2a2a'}},
                        y1: {position: 'right', stacked: true, ticks: {color: '#3498db'}, grid: {drawOnChartArea: false}}
                    }
                }
            });

            let cumulativeRain = [], cumulativeSnow = [], cumulativeTotal = [];
            let sumRain = 0, sumSnow = 0, sumTotal = 0;
            for (let i = 0; i < hours.length; i++) {
                sumRain += rain[i] || 0;
                sumSnow += snow[i] || 0;
                sumTotal += totalPrecip[i] || 0;
                cumulativeRain.push(sumRain);
                cumulativeSnow.push(sumSnow);
                cumulativeTotal.push(sumTotal);
            }

            if (precipAccumChart) precipAccumChart.destroy();
            precipAccumChart = new Chart(document.getElementById('precipAccumChart'), {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Total Accumulation (in)',
                        data: cumulativeTotal,
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        fill: true
                    }, {
                        label: 'Rain Accumulation (in)',
                        data: cumulativeRain,
                        borderColor: '#3498db',
                        tension: 0.4,
                        borderWidth: 2
                    }, {
                        label: 'Snow Accumulation (in)',
                        data: cumulativeSnow,
                        borderColor: '#ffffff',
                        tension: 0.4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {labels: {color: '#e0e0e0'}}},
                    scales: {
                        x: {ticks: {color: '#999', maxRotation: 45}, grid: {color: '#2a2a2a'}},
                        y: {ticks: {color: '#9b59b6'}, grid: {color: '#2a2a2a'}}
                    }
                }
            });

            if (windChart) windChart.destroy();
            windChart = new Chart(document.getElementById('windChart'), {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Wind Speed (mph)',
                        data: wind,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }, {
                        label: 'Wind Gusts (mph)',
                        data: gusts,
                        borderColor: '#e74c3c',
                        tension: 0.4,
                        borderWidth: 2,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {labels: {color: '#e0e0e0'}}},
                    scales: {
                        x: {ticks: {color: '#999', maxRotation: 45}, grid: {color: '#2a2a2a'}},
                        y: {ticks: {color: '#f39c12'}, grid: {color: '#2a2a2a'}}
                    }
                }
            });
        }

        function generateHistoricalChart(historicalData) {
            if (!historicalData?.hourly) return;

            const hours = historicalData.hourly.time.map(time => 
                new Date(time).toLocaleString('en-US', {month: 'short', day: 'numeric', hour: 'numeric'})
            );
            const temps = historicalData.hourly.temperature_2m || [];
            const wind = historicalData.hourly.wind_speed_10m || [];
            const gusts = historicalData.hourly.wind_gusts_10m || wind.map(w => w * 1.3);
            const rain = historicalData.hourly.rain || [];
            const snow = historicalData.hourly.snowfall || [];

            let cumulativeRain = [], cumulativeSnow = [];
            let sumRain = 0, sumSnow = 0;
            for (let i = 0; i < rain.length; i++) {
                sumRain += rain[i] || 0;
                sumSnow += snow[i] || 0;
                cumulativeRain.push(sumRain);
                cumulativeSnow.push(sumSnow);
            }

            if (historicalChart) historicalChart.destroy();
            historicalChart = new Chart(document.getElementById('historicalChart'), {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Temperature (°F)',
                        data: temps,
                        borderColor: '#4a90e2',
                        tension: 0.4,
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Wind (mph)',
                        data: wind,
                        borderColor: '#f39c12',
                        tension: 0.4,
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Gusts (mph)',
                        data: gusts,
                        borderColor: '#e74c3c',
                        tension: 0.4,
                        borderWidth: 1,
                        borderDash: [3, 3],
                        yAxisID: 'y'
                    }, {
                        label: 'Rain (in)',
                        data: cumulativeRain,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        borderWidth: 2,
                        fill: true,
                        yAxisID: 'y1'
                    }, {
                        label: 'Snow (in)',
                        data: cumulativeSnow,
                        borderColor: '#ffffff',
                        tension: 0.4,
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {labels: {color: '#e0e0e0'}}},
                    scales: {
                        x: {ticks: {color: '#999', maxRotation: 45}, grid: {color: '#2a2a2a'}},
                        y: {position: 'left', ticks: {color: '#4a90e2'}, grid: {color: '#2a2a2a'}},
                        y1: {position: 'right', ticks: {color: '#3498db'}, grid: {drawOnChartArea: false}}
                    }
                }
            });
        }

        function generateDailyForecasts(hourlyData, startIndex) {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrowStart = new Date(todayStart);
            tomorrowStart.setDate(tomorrowStart.getDate() + 1);
            const dayAfterStart = new Date(todayStart);
            dayAfterStart.setDate(dayAfterStart.getDate() + 2);
            const dayAfterEnd = new Date(dayAfterStart);
            dayAfterEnd.setDate(dayAfterEnd.getDate() + 1);

            function getDayData(dayStart, dayEnd) {
                const dayIndices = [];
                for (let i = 0; i < hourlyData.time.length; i++) {
                    const time = new Date(hourlyData.time[i]);
                    if (time >= dayStart && time < dayEnd) dayIndices.push(i);
                }
                if (dayIndices.length === 0) return null;

                const dayTemps = dayIndices.map(i => hourlyData.temperature_2m[i]);
                const dayWind = dayIndices.map(i => hourlyData.wind_speed_10m[i]);
                const dayGusts = dayIndices.map(i => hourlyData.wind_gusts_10m?.[i] || hourlyData.wind_speed_10m[i] * 1.3);
                const dayRain = dayIndices.map(i => hourlyData.rain?.[i] || 0);
                const daySnow = dayIndices.map(i => hourlyData.snowfall?.[i] || 0);

                return {
                    highTemp: Math.max(...dayTemps),
                    lowTemp: Math.min(...dayTemps),
                    highWind: Math.max(...dayWind),
                    highGusts: Math.max(...dayGusts),
                    totalRain: dayRain.reduce((a, b) => a + b, 0),
                    totalSnow: daySnow.reduce((a, b) => a + b, 0)
                };
            }

            function formatDayForecast(data) {
                if (!data) return '<div class="daily-value">No data</div>';
                return `
                    <div class="daily-stat"><span class="daily-label">Temp:</span><span class="daily-value temp">${Math.round(data.lowTemp)}°-${Math.round(data.highTemp)}°F</span></div>
                    <div class="daily-stat"><span class="daily-label">Wind:</span><span class="daily-value wind">${Math.round(data.highWind)} mph</span></div>
                    <div class="daily-stat"><span class="daily-label">Gusts:</span><span class="daily-value wind">${Math.round(data.highGusts)} mph</span></div>
                    <div class="daily-stat"><span class="daily-label">Rain:</span><span class="daily-value rain">${data.totalRain.toFixed(2)}"</span></div>
                    <div class="daily-stat"><span class="daily-label">Snow:</span><span class="daily-value snow">${data.totalSnow.toFixed(2)}"</span></div>
                `;
            }

            document.getElementById('todayForecast').innerHTML = formatDayForecast(getDayData(now, tomorrowStart));
            document.getElementById('tomorrowForecast').innerHTML = formatDayForecast(getDayData(tomorrowStart, dayAfterStart));
            document.getElementById('dayAfterForecast').innerHTML = formatDayForecast(getDayData(dayAfterStart, dayAfterEnd));
        }

        function generateHourlyTable(hours, temps, feelsLike, precipProb, totalPrecip, rain, snow, wind, gusts) {
            let html = '<table class="hourly-table"><thead><tr><th>Time</th><th>Temp</th><th>Feels</th><th>Precip %</th><th>Rain</th><th>Snow</th><th>Wind</th><th>Gusts</th></tr></thead><tbody>';
            for (let i = 0; i < hours.length; i++) {
                html += `<tr>
                    <td>${hours[i]}</td>
                    <td class="temp-cell">${Math.round(temps[i])}°F</td>
                    <td class="temp-cell">${Math.round(feelsLike[i])}°F</td>
                    <td class="precip-cell">${Math.round(precipProb[i])}%</td>
                    <td class="rain-cell">${rain[i].toFixed(2)}"</td>
                    <td class="snow-cell">${snow[i].toFixed(2)}"</td>
                    <td class="wind-cell">${Math.round(wind[i])} mph</td>
                    <td class="wind-cell">${Math.round(gusts[i])} mph</td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('hourlyTable').innerHTML = html;
        }

        function getWeatherDescription(code) {
            const codes = {0:'Clear',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',48:'Rime fog',51:'Light drizzle',53:'Moderate drizzle',55:'Dense drizzle',61:'Slight rain',63:'Moderate rain',65:'Heavy rain',71:'Slight snow',73:'Moderate snow',75:'Heavy snow',77:'Snow grains',80:'Slight showers',81:'Moderate showers',82:'Violent showers',85:'Slight snow showers',86:'Heavy snow showers',95:'Thunderstorm',96:'Thunderstorm + hail',99:'Thunderstorm + heavy hail'};
            return codes[code] || 'Unknown';
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').classList.add('active');
        }

        window.addEventListener('load', () => getForecast(28.2189, -82.4526));
    </script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }
</script>
</body>
</html>
